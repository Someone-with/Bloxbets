<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donate → Game Points</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:560px;margin:2rem auto;padding:1rem;background:#f9f9fb;color:#222;}
    h1{color:#5865F2;}
    label{display:block;margin:1rem 0 .4rem;font-weight:bold;}
    input,button{padding:.7rem;font-size:1rem;width:100%;border:1px solid #ccc;border-radius:6px;}
    #paypal-button-container{margin-top:1.5rem;}
    .success{background:#d4edda;color:#155724;padding:1rem;border-radius:6px;margin-top:1rem;display:none;}
    .setup{background:#fff3cd;color:#856404;padding:1rem;border-radius:6px;margin-bottom:1.5rem;}
  </style>
</head>
<body>

  <!-- ---------- 1. DISCORD WEBHOOK SETUP (once) ---------- -->
  <div id="setupBox" class="setup">
    <strong>Setup (only once)</strong><br>
    <label>Discord Webhook URL (full URL):</label>
    <input id="discordWebhook" type="url" placeholder="https://discord.com/api/webhooks/…">
    <button onclick="saveWebhook()">Save & Hide</button>
    <small style="display:block;margin-top:.5rem;">
      Paste the webhook URL from your Discord channel → Integrations → Webhooks.
    </small>
  </div>

  <!-- ---------- 2. DONATION FORM ---------- -->
  <h1>Support the Game!</h1>
  <p>Every $1 = 1 point in-game. Your Discord ID will be announced.</p>

  <label>Discord User ID (optional):</label>
  <input id="discordId" type="text" placeholder="123456789012345678">

  <div id="paypal-button-container"></div>

  <div id="success" class="success">
    Donation received! Points added in Discord.
  </div>

  <!-- ---------- PayPal SDK ---------- -->
  <script src="https://www.paypal.com/sdk/js?client-id=AUp0UM3hJPic-OtC2uaIKjs0EJLxxn0zVNZVrHs1C-GVK-5BaI0gHj10iNbgpS4fnwPuGUcqGUCGcrPy&currency=USD"></script>

  <script>
    /* ---------- LocalStorage helper ---------- */
    const STORAGE_KEY = 'discord_webhook_url';
    const webhookInput = document.getElementById('discordWebhook');
    const setupBox     = document.getElementById('setupBox');
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { webhookInput.value = saved; setupBox.style.display='none'; }

    function saveWebhook() {
      const url = webhookInput.value.trim();
      if (!url) return alert('Enter a valid webhook URL');
      localStorage.setItem(STORAGE_KEY, url);
      setupBox.style.display='none';
    }

    /* ---------- PayPal button ---------- */
    const discordIdInput = document.getElementById('discordId');
    const successDiv     = document.getElementById('success');
    const webhookUrl     = () => localStorage.getItem(STORAGE_KEY);

    paypal.Buttons({
      createOrder: (data, actions) => {
        let amount = prompt('How much would you like to donate? (USD)', '5.00');
        if (!amount) return;
        amount = parseFloat(amount);
        if (isNaN(amount) || amount <= 0) { alert('Invalid amount'); return; }
        return actions.order.create({
          purchase_units: [{ amount: { value: amount.toFixed(2) } }]
        });
      },

      onApprove: async (data, actions) => {
        return actions.order.capture().then(async details => {
          const amount = details.purchase_units[0].amount.value;
          const discordId = discordIdInput.value.trim();
          const mention = discordId ? `<@${discordId}>` : 'Anonymous';

          const message = {
            content: `**Game deposit!**\nUser ${mention}\nPoints (${amount})`
          };

          const wh = webhookUrl();
          if (!wh) return alert('Discord webhook not configured. Refresh and set it first.');

          try {
            const resp = await fetch(wh, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(message)
            });
            if (!resp.ok) throw new Error('Discord returned '+resp.status);
            successDiv.style.display = 'block';
          } catch (e) {
            console.error(e);
            alert('Payment succeeded but Discord message failed. Contact the admin.');
          }
        });
      },

      onError: err => {
        console.error(err);
        alert('Payment error – try again.');
      }
    }).render('#paypal-button-container');
  </script>
</body>
</html>
